# ZFS Manual

- ZFS 池存储

使用存储池概念来管理物理存储．以前,文件系统是在单个物理设备的基础上构
造的。为了利用多个设备和提供数据冗余性,引入了卷管理器的概念来提供单个设备
的表示,以便无需修改文件系统即可利用多个设备。此设计增加了更多复杂性,并最
终阻碍了特定文件系统的继续发展,因为这类文件系统无法控制数据在虚拟卷上的物
理放置。

ZFS 可完全避免使用卷管理。ZFS 将设备聚集到存储池中,而不是强制要求创建虚拟
卷。存储池描述了存储的物理特征(设备布局、数据冗余等),并充当可以从其创建
文件系统的任意数据存储库。文件系统不再受限于单个设备,允许它们与池中的所有
文件系统共享磁盘空间。您不再需要预先确定文件系统的大小,因为文件系统会在分
配给存储池的磁盘空间内自动增长。添加新存储器后,无需执行其他操作,池中的所
有文件系统即可立即使用所增加的磁盘空间。在许多方面,存储池与虚拟内存系统相
似:将一个内存 DIMM 加入系统时,操作系统并不强迫您运行命令来配置内存并将其
指定给个别进程。系统中的所有进程都会自动使用所增加的内存。

- 事务性语义

ZFS 是事务性文件系统,这意味着文件系统状态在磁盘上始终是一致的。传统文件系统
可就地覆盖数据,这意味着如果系统断电(例如,在分配数据块到将其链接到目录中
的时间段内断电),则会使文件系统处于不一致状态。以前,此问题是通过使用 fsck
命令解决的。此命令负责检查并验证文件系统状态,并尝试在操作过程中修复任何不
一致性。这种文件系统不一致问题曾给管理员造成巨大困扰,fsck 命令并不保证能够
解决所有可能的问题。最近,文件系统引入了日志记录的概念。日志记录过程在单独
的日志中记录操作,在系统发生崩溃时,可以安全地重放该日志。由于数据需要写入
两次,因此该过程会引入不必要的开销,而且通常会导致一组新问题,例如在无法正
确地重放日志时。

对于事务性文件系统,数据是使用写复制语义管理的。数据永远不会被覆盖,并且任
何操作序列会全部被提交或全部被忽略。因此,文件系统绝对不会因意外断电或系统
崩溃而被损坏。尽管最近写入的数据片段可能丢失,但是文件系统本身将始终是一致
的。此外,只有在写入同步数据(使用 O_DSYNC 标志写入)后才返回,因此同步数据决
不会丢失。

- 校验和与自我修复数据

对于 ZFS,所有数据和元数据都通过用户可选择的校验和算法进行验证。提供校验和验
证的传统文件系统出于卷管理层和传统文件系统设计的必要,会逐块执行此操作。在
传统设计中,某些故障可能导致数据不正确但没有校验和错误,如向错误位置写入完
整的块等。ZFS 校验和的存储方式可确保检测到这些故障并可以正常地从其中进行恢
复。所有校验和验证与数据恢复都是在文件系统层执行的,并且对应用程序是透明
的。

此外,ZFS 还会提供自我修复数据。ZFS 支持存储池具有各种级别的数据冗余性。检测
到坏的数据块时,ZFS 会从另一个冗余副本中提取正确的数据,而且会用正确的数据替
换错误的数据。

- 独一无二的可伸缩性

ZFS 文件系统的一个关键设计要素是可伸缩性。该文件系统本身是 128 位的,所允许的
存储空间是 256 quadrillion zettabyte (256x1015 ZB)。所有元数据都是动态分配的,因此
在首次创建时无需预先分配 inode,否则就会限制文件系统的可伸缩性。所有算法在编
写时都考虑到了可伸缩性。目录最多可以包含 2 48 (256 万亿)项,并且对于文件系统
数或文件系统中可以包含的文件数不存在限制。

- ZFS 快照

快照是文件系统或卷的只读副本。可以快速而轻松地创建快照。最初,快照不会占用
池中的任何附加磁盘空间。

活动数据集中的数据更改时,快照通过继续引用旧数据来占用磁盘空间。因此,快照
可防止将数据释放回池中。

- 简化的管理

最重要的是,ZFS 提供了一种极度简化的管理模型。通过使用分层次的文件系统布
局、属性继承以及自动管理挂载点和 NFS 共享语义,ZFS 可轻松创建和管理文件系
统,而无需使用多个命令或编辑配置文件。可以轻松设置配额或预留空间,启用或禁
用压缩,或者通过单个命令管理许多文件系统的挂载点。您就可以检查或替换设
备,而无需学习另外的一套卷管理命令。您可以发送和接收文件系统快照流

ZFS 通过分层结构管理文件系统,该分层结构允许对属性(如配额、预留空间、压缩和
挂载点)进行这一简化管理。在此模型中,文件系统是中央控制点。文件系统本身的
开销非常小(相当于创建一个新目录),因此鼓励您为每个用户、项目、工作区等创
建一个文件系统。通过此设计,可定义细分的管理点。

- ZFS 磁盘空间记帐

ZFS 建立在池存储概念的基础上。与典型文件系统映射到物理存储器不同,池中的所有
ZFS 文件系统都共享该池中的可用存储器。因此,即使文件系统处于非活动状态,实用
程序(例如 df)报告的可用磁盘空间也会发生变化,因为池中的其他文件系统会使用
或释放磁盘空间。

ZFS 中的所有元数据都是动态分配的。其他大部分文件系统都会预分配其大量元数
据。因此,创建文件系统时,此元数据需要直接占用空间。此行为还意味着文件系统
支持的文件总数是预先确定的。由于 ZFS 根据需要分配其元数据,因此不需要初始空
间成本,并且文件数只受可用磁盘空间的限制。对于 ZFS 文件系统,对 df -g 命令输出
的解释必须和其他文件系统不同。报告的 total files 只是根据池中可用的存储量得出
的估计值。

ZFS 是事务性文件系统。大部分文件系统修改都捆绑到事务组中,并异步提交至磁
盘。这些修改在被提交到磁盘之前称为暂挂更改。已用磁盘空间量、可用磁盘空间量
以及文件或文件系统引用的磁盘空间量并不考虑暂挂更改。通常,暂挂更改仅占用几
秒钟的时间。即使使用 fsync(3c) 或 O_SYNC 提交对磁盘的更改,也不一定能保证有关
磁盘空间使用情况的信息会立即更新。

在 UFS 文件系统上,du 命令报告文件中数据块的大小。在 ZFS 文件系统上,du 报告在
磁盘上存储的文件的实际大小。该大小包括元数据以及压缩。此报告确实有助于解
答“删除此文件可获得多少多余空间?”这一问题。因此,即使压缩已关闭,您仍会在
ZFS 和 UFS 之间看到不同的结果。

对 df 命令与 zfs list 命令报告的空间占用进行比较时,请注意,df 报告的是池大小而
不仅仅是文件系统大小。此外,df 不了解后代文件系统或快照是否存在。如果在文件
系统上设置了任何 ZFS 属性(如压缩和配额),则协调由 df 报告的空间占用可能很
难。

请考虑也可能影响所报告的空间占用的以下情况:

对于大于 recordsize 的文件,文件的最后一个数据块通常只填充大约 1/2。当缺省
recordsize 设置为 128 KB 时,每个文件浪费大约 64 KB,这可能影响很大。集成
RFE 6812608 可解决此情况。通过启用压缩可解决此问题。即使数据已压缩,最后
一个数据块的未使用部分也将以零填充,且压缩非常好。

在 RAIDZ-2 池上,每个数据块至少要占用 2 个扇区(512 字节块)来存储奇偶校验
信息。奇偶校验信息所占用的空间不会被报告,但是因为它可能是变化的,且在小
数据块中所占的百分比更大,因此对空间报告可能有显著影响。对于设置为 512 字
节的 recordsize,影响更为明显,其中每个 512 字节的逻辑数据块都占用 1.5
KB(该空间的 3 倍)。不管存储什么数据,如果您最关注的是空间效率,则应该将
recordsize 保留为缺省值 (128 KB),并启用压缩(至 lzjb 的缺省值)。

- 使用日志设备创建 ZFS 存储池

为了满足对同步事务的 POSIX 要求,提供了 ZFS 意图日志 (ZFS intent log, ZIL)。例
如,数据库通常要求其事务在从系统调用中返回时应该在稳定的存储设备上。NFS 和
其他应用程序还可以使用 fsync() 来确保数据稳定性。
缺省情况下,ZIL 是通过主池中的块分配的。但是,通过使用单独的意图日志设备(如
使用 NVRAM 或专用磁盘)可能会获得更佳的性能。

确定设置 ZFS 日志设备是否适合您的环境时,请考虑以下几点:

ZFS 意图日志的日志设备与数据库日志文件无关。

通过实施单独的日志设备获得的任何性能改进均取决于设备类型、池的硬件配
置,以及应用程序工作负荷。有关初步性能信息,请参见以下博客:
http://blogs.oracle.com/perrin/entry/slog_blog_or_blogging_on


- 显示存储池虚拟设备信息

每个存储池都包含一个或多个虚拟设备。虚拟设备是存储池的内部表示形式,用于描
述物理存储器的布局以及存储池的故障特征。因此,虚拟设备表示用于创建存储池的
磁盘设备或文件。一个池可以在配置的顶层具有任意数目的虚拟设备,称为顶层
vdev.

